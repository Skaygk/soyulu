<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Day - SIGMIZA</title>
<style>
body {
  font-family: Arial, sans-serif;
  background-color: #000;
  color: #9400D3;
  margin: 0;
  padding: 20px;
  text-align: center;
}

h1 {
  color: #9400D3;
  font-size: 3em;
  margin: 20px 0;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0%,100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

img {
  max-width: 90%;
  margin: 10px auto;
  display: block;
}

a {
  color: #9400D3;
  text-decoration: none;
  font-size: 1.2em;
  display: inline-block;
  margin: 20px;
}


.upload-container {
  margin: 30px auto;
  max-width: 400px;
}

#fileInput { width: 100%; margin-bottom: 15px; }

#uploadBtn {
  width: 100%;
  padding: 12px;
  background: #b84cff;
  color: #000;
  border: none;
  font-weight: bold;
  font-size: 16px;
  cursor: pointer;
  border-radius: 8px;
  transition: transform 0.2s ease, background 0.2s ease;
}

#uploadBtn:hover {
  background: #9400d3;
  transform: scale(1.05);
}

#uploadStatus {
  margin-top: 15px;
  word-break: break-all;
  font-size: 14px;
}


.table-wrapper { overflow-x: auto; margin-top: 30px; }
table { width: 100%; border-collapse: collapse; color: #fff; }
th, td { border: 2px solid #9400D3; padding: 8px; }
th { background: #120012; color: #b84cff; }
button.ver { background: #4caf50; color: #000; cursor: pointer; border: none; padding: 5px 10px; border-radius: 5px; }
button.ver:hover { background: #6bdc6b; }
button.borrar { background: #ff00aa; color: #000; cursor: pointer; border: none; padding: 5px 10px; border-radius: 5px; }
button.borrar:hover { background: #ff33cc; }

#modal { display: none; position: fixed; inset:0; background: rgba(0,0,0,0.85); }
#modal-box { background:#000; color:#b84cff; border:2px solid #9400D3; width:90%; max-width:600px; margin:10% auto; padding:20px; text-align:left; position: relative; }
#cerrar { position:absolute; top:10px; right:15px; cursor:pointer; font-weight:bold; }
</style>
</head>
<body>

<h1>"Day"</h1>

<div class="upload-container">
  <input type="file" id="fileInput" accept="image/*,video/*">
  <button id="uploadBtn">Subir Archivo</button>
  <p id="uploadStatus"></p>
</div>

<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Archivo</th>
        <th>Usuario</th>
        <th>Fecha</th>
        <th>Ver</th>
        <th>Borrar</th>
      </tr>
    </thead>
    <tbody id="fileList"></tbody>
  </table>
</div>

<div id="modal">
  <div id="modal-box">
    <span id="cerrar">X</span>
    <h2 id="m-archivo"></h2>
    <p id="m-usuario"></p>
    <pre id="m-detalle"></pre>
    <p id="m-fecha"></p>
  </div>
</div>

<a href="../index.html">← Volver</a>

<script>
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const uploadStatus = document.getElementById('uploadStatus');
const fileList = document.getElementById('fileList');

const modal = document.getElementById('modal');
const cerrar = document.getElementById('cerrar');
const mArchivo = document.getElementById('m-archivo');
const mUsuario = document.getElementById('m-usuario');
const mDetalle = document.getElementById('m-detalle');
const mFecha = document.getElementById('m-fecha');

cerrar.onclick = ()=>modal.style.display='none';

async function registrarVisita() {
  try { await fetch('/api/track', { method: 'POST' }); } catch(e){ console.error(e); }
}

async function cargarArchivos() {
  try {
    const res = await fetch('/api/obtenerArchivos');
    const data = await res.json();
    fileList.innerHTML = '';

    data.forEach(f => {
      const tr = document.createElement('tr');
      const td = (txt)=>{ const td=document.createElement('td'); td.textContent=txt; return td; };
      tr.append(td(f.nombre), td(f.usuario), td(new Date(f.fecha).toLocaleString()));

      const tdVer = document.createElement('td');
      const btnVer = document.createElement('button');
      btnVer.textContent='Ver'; btnVer.className='ver';
      btnVer.onclick = ()=>abrirModal(f);
      tdVer.appendChild(btnVer);

      const tdBorrar = document.createElement('td');
      const btnBorrar = document.createElement('button');
      btnBorrar.textContent='Borrar'; btnBorrar.className='borrar';
      btnBorrar.onclick = ()=>borrarArchivo(f.id);
      tdBorrar.appendChild(btnBorrar);

      tr.append(tdVer, tdBorrar);
      fileList.appendChild(tr);
    });
  } catch(e){ console.error(e); }
}

function abrirModal(f){
  mArchivo.textContent=f.nombre;
  mUsuario.textContent='Usuario: '+f.usuario;
  mDetalle.textContent=f.detalle||'';
  mFecha.textContent=new Date(f.fecha).toLocaleString();
  modal.style.display='block';
}

uploadBtn.addEventListener('click', async () => {
  const file = fileInput.files[0];
  if (!file) { uploadStatus.textContent='Selecciona un archivo'; return; }

  uploadStatus.textContent='Subiendo...';
  const formData = new FormData();
  formData.append('file', file);

  try {
    const res = await fetch('/api/uploadFile', { method:'POST', body: formData });
    const data = await res.json();
    if(data.ok){
      uploadStatus.innerHTML=`Archivo subido: <a href="${data.url}" target="_blank">${data.url}</a>`;
      fileInput.value='';
      cargarArchivos();
    } else uploadStatus.textContent='Error: '+data.error;
  } catch(e){ uploadStatus.textContent='Error al subir'; console.error(e); }
});

async function borrarArchivo(id){
  const pass = prompt('Contraseña admin:');
  if(!pass) return;
  try {
    const res = await fetch('/api/borrarArchivo', { 
      method:'POST', 
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({id,password:pass})
    });
    const r = await res.json();
    if(r.ok) cargarArchivos(); else alert(r.error);
  } catch(e){ console.error(e); }
}

window.onload = ()=>{
  registrarVisita();
  cargarArchivos();
};
</script>

</body>
</html>
