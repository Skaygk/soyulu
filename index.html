<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIGMIZA</title>

<style>
body {
  font-family: Arial;
  background: #000;
  color: #9400D3;
  text-align: center;
  margin: 0;
  padding: 20px;
}

.logo-container {
  text-align: center;
  margin: 20px 0;
}

.logo {
  width: 50%;      
  max-width: 300px;    
  height: auto;       
  animation: latido 1.8s infinite ease-in-out;
}

@keyframes latido {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.15); } 
}

table {
  width: 90%;
  max-width: 900px;
  margin: 20px auto;
  border-collapse: collapse;
  color: #fff;
}

th, td {
  border: 2px solid #9400D3;
  padding: 10px;
}

th {
  background: #120012;
  color: #b84cff;
}

button {
  padding: 6px 12px;
  background: #b84cff;
  border: none;
  font-weight: bold;
  cursor: pointer;
}

button.borrar {
  background: #ff00aa;
  color: #000;
}

button.borrar:hover {
  background: #ff33cc;
}

#modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
}

#modal-box {
  background: #000;
  color: #b84cff;
  border: 2px solid #9400D3;
  width: 80%;
  max-width: 600px;
  margin: 10% auto;
  padding: 20px;
  text-align: left;
}

#cerrar {
  float: right;
  cursor: pointer;
  font-weight: bold;
}
</style>
</head>

<body>

<div class="logo-container">
  <img src="recursos/sigma.jpg" alt="SIGMIZA" class="logo">
</div>

<a href="upload.html">Subir carpeta</a>

<table>
<thead>
<tr>
  <th>Titulo</th>
  <th>Autor</th>
  <th>Usuario</th>
  <th>Contenido</th>
  <th>Fecha</th>
  <th>Ver</th>
  <th>Borrar</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>

<div id="modal">
  <div id="modal-box">
    <span id="cerrar">X</span>
    <h2 id="m-titulo"></h2>
    <p id="m-autor"></p>
    <pre id="m-contenido"></pre>
    <p id="m-fecha"></p>
  </div>
</div>

<script>
async function registrarVisita() {
  try {
    await fetch('/api/track', { method: 'POST' });
  } catch (err) {
    console.error('Error al registrar visita', err);
  }
}

async function cargarCarpetas() {
  try {
    const res = await fetch('/api/obtenerCarpetas');
    const data = await res.json();
    const tbody = document.getElementById('lista');
    tbody.innerHTML = '';

    data.forEach(f => {
      const tr = document.createElement('tr');

      const t1 = document.createElement('td'); t1.textContent = f.titulo;
      const t2 = document.createElement('td'); t2.textContent = f.autor;
      const t3 = document.createElement('td'); t3.textContent = f.subido_por;
      const t4 = document.createElement('td'); t4.textContent = f.contenido.length > 50 ? f.contenido.slice(0,50)+'...' : f.contenido;
      const t5 = document.createElement('td'); t5.textContent = f.created_at ? new Date(f.created_at).toLocaleString() : 'Sin fecha';

    
      const t6 = document.createElement('td');
      const btnVer = document.createElement('button');
      btnVer.textContent = 'Ver';
      btnVer.onclick = () => abrirModal(f);
      t6.appendChild(btnVer);

      const t7 = document.createElement('td');
      const btnBorrar = document.createElement('button');
      btnBorrar.textContent = 'Borrar';
      btnBorrar.className = 'borrar';
      btnBorrar.onclick = () => borrarCarpeta(f.id);
      t7.appendChild(btnBorrar);

      tr.append(t1,t2,t3,t4,t5,t6,t7);
      tbody.appendChild(tr);
    });
  } catch(e) {
    console.error(e);
  }
}

function abrirModal(f) {
  document.getElementById('m-titulo').textContent = f.titulo;
  document.getElementById('m-autor').textContent = 'Autor: ' + f.autor;
  document.getElementById('m-contenido').textContent = f.contenido;
  document.getElementById('m-fecha').textContent = f.created_at ? 'Fecha: '+new Date(f.created_at).toLocaleString() : '';
  document.getElementById('modal').style.display = 'block';
}

document.getElementById('cerrar').onclick = () => {
  document.getElementById('modal').style.display = 'none';
};

async function borrarCarpeta(id) {
  const password = prompt('Ingrese la contraseÃ±a de admin para borrar este doxx:');
  if(!password) return;

  try {
    const res = await fetch('/api/borrarCarpeta', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ id, password })
    });
    const r = await res.json();
    if(r.ok) {
      alert('doxx borrado');
      cargarCarpetas();
    } else {
      alert('Error: '+r.error);
    }
  } catch(e) {
    console.error(e);
    alert('no se pudo');
  }
}

window.onload = () => {
  registrarVisita();
  cargarCarpetas();
};
</script>

</body>
</html>
