<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>

<style>
* {
  box-sizing: border-box;
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
}


body {
  background: #000;
  color: #b84cff;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}


.card {
  width: 360px;
  border: 2px solid #b84cff;
  padding: 30px;
  text-align: center;
}


h1 {
  margin-bottom: 25px;
  letter-spacing: 2px;
}


input {
  width: 100%;
  padding: 12px;
  margin-bottom: 15px;
  background: #000;
  border: 2px solid #b84cff;
  color: #b84cff;
  outline: none;
}

input::placeholder {
  color: #7a2fc9;
}


button {
  width: 100%;
  padding: 12px;
  background: #b84cff;
  border: none;
  color: #000;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}

button:hover {
  background: #e000ff;
}

#deleteBtn {
  width: auto;
  padding: 10px 20px;
  margin-bottom: 15px;
  background: #ff00aa;
  color: #000;
  border: 2px solid #b84cff;
  cursor: pointer;
}

#deleteBtn:hover {
  background: #ff33cc;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  font-size: 14px;
}

th, td {
  border: 1px solid #b84cff;
  padding: 8px;
  text-align: center;
}

th {
  background: #120012;
}


.panel {
  display: none;
  width: 90vw;
  max-width: 900px;
  border: 2px solid #b84cff;
  padding: 20px;
  text-align: center;
}
</style>
</head>

<body>

<div class="card" id="loginDiv">
  <h1>ADMIN</h1>
  <input type="password" id="pass" placeholder="Contraseña">
  <button onclick="login()">ENTRAR</button>
</div>

<div class="panel" id="panelDiv">
  <h1>PANEL DE VISITAS</h1>
  <button id="deleteBtn">BORRAR TODAS LAS IPs</button>
  <table>
    <thead>
      <tr>
        <th>IP</th>
        <th>Pais</th>
        <th>Ciudad</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody id="data"></tbody>
  </table>
</div>

<script>
const SESION_TIEMPO = 20 * 60 * 1000; 

function guardarSesion(pass) {
  localStorage.setItem('admin_sesion', JSON.stringify({
    pass: pass,
    expira: Date.now() + SESION_TIEMPO
  }));
}

function sesionValida() {
  const s = localStorage.getItem('admin_sesion');
  if (!s) return false;
  const data = JSON.parse(s);
  if (Date.now() > data.expira) {
    localStorage.removeItem('admin_sesion');
    return false;
  }
  return true;
}

function obtenerPassSesion() {
  const s = localStorage.getItem('admin_sesion');
  if (!s) return null;
  const data = JSON.parse(s);
  data.expira = Date.now() + SESION_TIEMPO;
  localStorage.setItem('admin_sesion', JSON.stringify(data));
  return data.pass;
}

async function login() {
  const pass = document.getElementById('pass').value.trim();
  if (!pass) return alert('Ingrese contraseña');

  try {
    const res = await fetch('/api/admin', { headers: { Authorization: pass } });
    if (!res.ok) return alert('Contraseña incorrecta, deja de joder');
    guardarSesion(pass);
    mostrarPanel(await res.json());
  } catch(e) {
    console.error(e);
    alert('Error en el login');
  }
}

function mostrarPanel(data) {
  document.getElementById('data').innerHTML = data.map(v => `
    <tr>
      <td>${v.ip}</td>
      <td>${v.country}</td>
      <td>${v.city}</td>
      <td>${new Date(v.created_at).toLocaleString()}</td>
    </tr>
  `).join('');
  document.getElementById('loginDiv').style.display = 'none';
  document.getElementById('panelDiv').style.display = 'block';
}

document.getElementById('deleteBtn').addEventListener('click', async () => {
  if (!confirm('¿Seguro de borrar todas las IPs?')) return;
  const pass = obtenerPassSesion();
  if (!pass) return alert('Sesión expirada, ingrese contraseña');

  try {
    const res = await fetch('/api/delete', { method: 'POST', headers: { Authorization: pass } });
    if (res.ok) {
      alert('borradas');
      document.getElementById('data').innerHTML = '';
    } else {
      alert('Error al borrar');
    }
  } catch(e) {
    console.error(e);
    alert('Error al borrar');
  }
});

window.onload = async () => {
  if (!sesionValida()) return;

  const pass = obtenerPassSesion();
  if (!pass) return;

  try {
    const res = await fetch('/api/admin', { headers: { Authorization: pass } });
    if (res.ok) mostrarPanel(await res.json());
    else localStorage.removeItem('admin_sesion');
  } catch(e) {
    console.error(e);
    localStorage.removeItem('admin_sesion');
  }
};
</script>

<script>
  window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
</script>
<script defer src="/_vercel/speed-insights/script.js"></script>

</body>
</html>
